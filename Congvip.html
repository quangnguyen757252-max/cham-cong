<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ch·∫•m C√¥ng C√° Nh√¢n</title>

<style>
*{box-sizing:border-box}
html,body{
  height:100%;
  overflow:hidden;
  overscroll-behavior:none;
}
body{
  position:fixed;
  inset:0;
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#000;
  background-size:cover;
  background-position:center;
}

/* ===== LAYOUT ===== */
.wrapper{height:100%;padding:6px 20px 14px;display:flex}
.card{
  width:100%;
  max-width:1000px;
  margin:auto;
  padding:16px;
  padding-bottom:calc(16px + env(safe-area-inset-bottom));
  border-radius:30px;
  background:rgba(255,255,255,.15);
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

/* ===== HEADER ===== */
.header-bar{
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom:12px;
}

.avatar{
  width:60px;
  height:60px;
  border-radius:50%;
  background:#e5e5ea;
  background-size:cover;
  background-position:center;
  border:3px solid #fff;
  flex-shrink:0;
}

.header-info{display:flex;flex-direction:column}

.title{
  font-size:30px;
  font-weight:900;
  background:linear-gradient(45deg,#007aff,#34c759);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  letter-spacing:.8px;
  text-shadow:0 3px 8px rgba(0,0,0,.2);
}

.clock-inline{
  font-size:17px;
  font-weight:800;
  color:#2c2c2e;
  margin-top:4px;
  padding:4px 10px;
  border-radius:12px;
  background:rgba(0,122,255,.1);
  display:inline-block;
}

/* ===== INFO ===== */
.info-box{
  background:rgba(255,255,255,.7);
  border-radius:18px;
  padding:10px;
}
.info-header{
  display:flex;
  justify-content:space-between;
  font-weight:800;
  cursor:pointer;
}
.info-content{max-height:0;overflow:hidden;transition:.3s}
.info-content.active{max-height:260px;margin-top:6px}
.info-content input{
  width:100%;
  padding:8px;
  border-radius:12px;
  border:none;
  margin:4px 0;
}

/* ===== BUTTON ===== */
.action-row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin:10px 0;
}
.action-row button{
  padding:12px;
  border:none;
  border-radius:30px;
  font-weight:800;
}
.primary{background:#34c759;color:#fff}
.danger{background:#ff3b30;color:#fff}
.noteBtn{background:#007aff;color:#fff}
.gray{background:#8e8e93;color:#fff}

/* ===== MONTH ===== */
.month-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:900;
}
.month-bar button{
  background:#007aff;
  border:none;
  color:#fff;
  border-radius:14px;
  padding:5px 12px;
}

/* ===== WEEK ===== */
.week{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  text-align:center;
  font-weight:800;
  margin-top:6px;
}
.week div:last-child{color:#ff3b30}

/* ===== CALENDAR ===== */
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
  margin-top:8px;
}
.day{
  position:relative;
  padding:10px 6px;
  border-radius:16px;
  background:rgba(255,255,255,.85);
  text-align:center;
  font-weight:900;
  font-size:15px;
  min-height:55px;
}
.day.selected{outline:3px solid #007aff}
.day.today{outline:3px solid #34c759}
.day.sun{color:#ff3b30}
.day.work{background:#c7f3d1}
.day.off{background:#ffd1d1}

/* Ca 12 vi·ªÅn ƒë·ªè d√†y */
.day.c12{
  border:4px solid #ff3b30;
  box-shadow:0 0 8px rgba(255,59,48,.6);
}

/* N·ª≠a ca chia 2 m√†u */
.day.half{
  background:linear-gradient(
    135deg,
    #c7f3d1 50%,
    #ffd1d1 50%
  );
}

.shift-label{font-size:11px;margin-top:4px}

.icon-wrap{
  position:absolute;
  top:4px;
  right:4px;
  display:flex;
  gap:3px;
  font-size:11px;
}

/* ===== SUMMARY ===== */
.summary{
  margin-top:12px;
  padding:14px;
  border-radius:20px;
  background:rgba(255,255,255,.92);
  font-size:14px;
  line-height:1.6;
}

.total-row{
  display:flex;
  justify-content:space-between;
}

.highlight{
  margin-top:10px;
  padding:12px;
  border-radius:16px;
  background:#e6f9ed;
  color:#0a7d34;
  font-weight:900;
  font-size:15px;
}

/* ===== SHEET ===== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  z-index:9;
}
.overlay.show{display:block}

.sheet{
  position:fixed;
  left:0;
  right:0;
  bottom:-100%;
  background:#fff;
  border-radius:28px 28px 0 0;
  padding:22px;
  transition:.35s;
  z-index:10;
}
.sheet.show{bottom:0}
.sheet button{
  width:100%;
  margin:8px 0;
  padding:18px;
  border-radius:24px;
  font-weight:900;
}

/* iOS keyboard */
.sheet.keyboard-up{
  transform:translateY(calc(-1 * var(--kb-height,260px)));
}
#noteInput{
  width:100%;
  height:120px;
  font-size:15px;
  padding:10px;
  border-radius:14px;
  resize:none;
}
</style>
</head>

<body>

<div class="wrapper">
<div class="card">

<!-- ===== HEADER ===== -->
<div class="header-bar">
  <div class="avatar" id="avatar"></div>
  <input type="file" id="avatarInput" hidden accept="image/*">
  <input type="file" id="bgInput" hidden accept="image/*">

  <div class="header-info">
    <div class="title" id="appTitle">Quang Nguy·ªÖn</div>
    <div class="clock-inline">
      <span id="dateText"></span> ‚Ä¢ 
      <span id="timeText"></span>
    </div>
  </div>
</div>

<!-- ===== INFO ===== -->
<div class="info-box">
  <div class="info-header" onclick="toggleInfo()">
    <span>Th√¥ng tin c√° nh√¢n</span>
    <span id="arrow">‚ñº</span>
  </div>

  <div class="info-content" id="infoContent">
    <input id="nameInput" placeholder="T√™n">
    <input id="jobInput" placeholder="C√¥ng vi·ªác">
    <input id="salaryInput" type="number" placeholder="L∆∞∆°ng/th√°ng">
    <button class="primary" onclick="saveProfile()">L∆∞u</button>
  </div>

  <div>
    T√™n: <b id="nameDisplay">‚Äî</b><br>
    C√¥ng vi·ªác: <b id="jobDisplay">‚Äî</b><br>
    L∆∞∆°ng/th√°ng: <b id="salaryDisplay">0</b> ƒë
  </div>
</div>

<!-- ===== BUTTON ===== -->
<div class="action-row">
  <button class="primary" onclick="openShift()">ƒêi l√†m</button>
  <button class="danger" onclick="markOff()">Ngh·ªâ</button>
  <button class="noteBtn" onclick="openNote()">Ghi ch√∫</button>
  <button class="gray" onclick="openReset()">Reset</button>
</div>

<!-- ===== MONTH ===== -->
<div class="month-bar">
  <button onclick="changeMonth(-1)">‚óÄ</button>
  <div id="monthLabel"></div>
  <button onclick="changeMonth(1)">‚ñ∂</button>
</div>

<div class="week">
  <div>T2</div><div>T3</div><div>T4</div>
  <div>T5</div><div>T6</div><div>T7</div><div>CN</div>
</div>

<div class="calendar" id="calendar"></div>

<!-- ===== SUMMARY (B·ªê C·ª§C CU·ªêI C√ôNG) ===== -->
<div class="summary">

  Th√°ng: <b id="totalDays">0</b> ng√†y | 
  CN: <b id="sundayCount">0</b> | 
  C√¥ng chu·∫©n: <b id="standardDays">0</b>
  <br>
  L∆∞∆°ng/ng√†y: <b id="salaryDisplay2">0</b> ƒë
  <hr>

  Ng√†y l√†m: <b id="workDays">0</b> | 
  Ng√†y ngh·ªâ: <b id="offDays">0</b> | 
  TƒÉng ca: <b id="overtimeHours">0</b>h 
  (<span id="overtimeWorkText">0</span>)
  
  <div class="highlight">
    <div class="total-row">
      <div>T·ªïng c√¥ng: <span id="totalWork">0</span></div>
      <div>Ti·ªÅn th√™m: <span id="extraMoney">0</span> ƒë</div>
    </div>
    <div style="margin-top:6px;">
      T·ªïng l∆∞∆°ng: <span id="totalSalary">0</span> ƒë
    </div>
  </div>

</div>

</div>
</div>

<!-- ===== OVERLAY ===== -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>

<!-- ===== AVATAR SHEET ===== -->
<div class="sheet" id="avatarSheet">
  <button class="primary" onclick="avatarInput.click()">ƒê·ªïi avatar</button>
  <button class="noteBtn" onclick="bgInput.click()">ƒê·ªïi ·∫£nh n·ªÅn</button>
  <button class="gray" onclick="closeAll()">ƒê√≥ng</button>
</div>

<!-- ===== SHIFT SHEET ===== -->
<div class="sheet" id="shiftSheet">
  <button onclick="selectShift('C1',1)">Ca 1</button>
  <button onclick="selectShift('C2',1)">Ca 2</button>
  <button onclick="selectShift('C3',1)">Ca 3</button>
  <button onclick="selectShift('C12',1.5)">Ca 12</button>
  <button onclick="selectShift('HC',1)">H√†nh ch√°nh</button>
  <button onclick="selectShift('¬Ω',0.5)">N·ª≠a ca</button>
  <button class="gray" onclick="closeAll()">ƒê√≥ng</button>
</div>

<!-- ===== NOTE SHEET ===== -->
<div class="sheet" id="noteSheet">
  <b>Ghi ch√∫</b>
  <textarea id="noteInput" placeholder="VD: tƒÉng ca 8h, t√†u 50k"></textarea>
  <button class="primary" onclick="saveNote()">L∆∞u</button>
  <button class="gray" onclick="closeAll()">ƒê√≥ng</button>
</div>

<!-- ===== RESET SHEET ===== -->
<div class="sheet" id="resetSheet">
  <h3 style="text-align:center;margin-top:0">X√°c nh·∫≠n reset?</h3>
  <button class="danger" onclick="confirmReset()">Reset</button>
  <button class="gray" onclick="closeAll()">Hu·ª∑</button>
</div>

<!-- ===== DETAIL SHEET ===== -->
<div class="sheet" id="detailSheet">
  <h3 id="detailTitle" style="text-align:center;margin-top:0"></h3>
  <p><b>Ca l√†m:</b> <span id="detailShift">‚Äî</span></p>
  <p><b>Gi·ªù tƒÉng ca:</b> <span id="detailHours">0</span> gi·ªù</p>
  <p><b>Ti·ªÅn th√™m:</b> <span id="detailMoney">0</span> ƒë</p>
  <p><b>Ghi ch√∫:</b></p>
  <div id="detailNote" style="background:#f2f2f7;padding:10px;border-radius:10px">
    Kh√¥ng c√≥
  </div>
  <button class="gray" onclick="closeAll()">ƒê√≥ng</button>
</div>

<script>

/* ===== CLOCK ===== */
const daysVN=["Ch·ªß nh·∫≠t","Th·ª© 2","Th·ª© 3","Th·ª© 4","Th·ª© 5","Th·ª© 6","Th·ª© 7"];
setInterval(()=>{
  const d=new Date();
  dateText.innerText=`${daysVN[d.getDay()]} ${d.toLocaleDateString()}`;
  timeText.innerText=d.toLocaleTimeString();
},1000);

/* ===== PROFILE ===== */
function toggleInfo(){
  infoContent.classList.toggle("active");
  arrow.innerText=infoContent.classList.contains("active")?"‚ñ≤":"‚ñº";
}

function saveProfile(){
  localStorage.setItem("name",nameInput.value.trim());
  localStorage.setItem("job",jobInput.value.trim());
  localStorage.setItem("salary",salaryInput.value||0);
  updateProfile();
  render();
}

function updateProfile(){
  nameDisplay.innerText=localStorage.getItem("name")||"‚Äî";
  jobDisplay.innerText=localStorage.getItem("job")||"‚Äî";
  salaryDisplay.innerText=
    Number(localStorage.getItem("salary")||0).toLocaleString();
  appTitle.innerText=
    localStorage.getItem("name")||"Quang Nguy·ªÖn";
}
updateProfile();

/* ===== AVATAR + BG ===== */
avatar.onclick=()=>{
  overlay.classList.add("show");
  avatarSheet.classList.add("show");
};

avatarInput.onchange=e=>{
  if(!e.target.files[0])return;
  const r=new FileReader();
  r.onload=()=>{
    avatar.style.backgroundImage=`url(${r.result})`;
    localStorage.setItem("avatar",r.result);
  };
  r.readAsDataURL(e.target.files[0]);
};

bgInput.onchange=e=>{
  if(!e.target.files[0])return;
  const r=new FileReader();
  r.onload=()=>{
    document.body.style.backgroundImage=`url(${r.result})`;
    localStorage.setItem("bg",r.result);
  };
  r.readAsDataURL(e.target.files[0]);
};

if(localStorage.getItem("avatar"))
  avatar.style.backgroundImage=`url(${localStorage.getItem("avatar")})`;
if(localStorage.getItem("bg"))
  document.body.style.backgroundImage=`url(${localStorage.getItem("bg")})`;

/* ===== DATA ===== */
let currentDate=new Date();
let selectedDay=null;
let lastClickDay=null;

const dataKey=()=>`data-${currentDate.getFullYear()}-${currentDate.getMonth()}`;
const noteKey=()=>`note-${currentDate.getFullYear()}-${currentDate.getMonth()}`;

function extractMoney(t){
  const m=t?.match(/(\d+)\s*k/i);
  return m?Number(m[1])*1000:0;
}
function extractHours(t){
  const h=t?.match(/(\d+(?:\.\d+)?)\s*h/gi)||[];
  return h.reduce((s,v)=>s+parseFloat(v),0);
}

/* ===== OPEN/CLOSE ===== */
function openShift(){
  if(selectedDay===null){alert("Ch·ªçn ng√†y tr∆∞·ªõc");return;}
  overlay.classList.add("show");
  shiftSheet.classList.add("show");
}
function openNote(){
  if(selectedDay===null){alert("Ch·ªçn ng√†y tr∆∞·ªõc");return;}
  const notes=JSON.parse(localStorage.getItem(noteKey()))||{};
  noteInput.value=notes[selectedDay]||"";
  overlay.classList.add("show");
  noteSheet.classList.add("show");
}
function openReset(){
  overlay.classList.add("show");
  resetSheet.classList.add("show");
}
function closeAll(){
  overlay.classList.remove("show");
  avatarSheet.classList.remove("show");
  shiftSheet.classList.remove("show");
  noteSheet.classList.remove("show");
  resetSheet.classList.remove("show");
  detailSheet.classList.remove("show");
}

/* ===== ACTION ===== */
function selectShift(label,value){
  const d=JSON.parse(localStorage.getItem(dataKey()))||{};
  d[selectedDay]={label,value};
  localStorage.setItem(dataKey(),JSON.stringify(d));
  closeAll();
  render();
}

function markOff(){
  if(selectedDay===null)return;
  const d=JSON.parse(localStorage.getItem(dataKey()))||{};
  d[selectedDay]={label:"OFF",value:0};
  localStorage.setItem(dataKey(),JSON.stringify(d));
  closeAll();
  render();
}

function saveNote(){
  const n=JSON.parse(localStorage.getItem(noteKey()))||{};
  n[selectedDay]=noteInput.value||"";
  localStorage.setItem(noteKey(),JSON.stringify(n));
  noteInput.value="";
  closeAll();
  render();
}

function confirmReset(){
  localStorage.removeItem(dataKey());
  localStorage.removeItem(noteKey());
  selectedDay=null;
  lastClickDay=null;
  render();
  closeAll();
}

/* ===== DETAIL ===== */
function openDetail(day){
  const data=JSON.parse(localStorage.getItem(dataKey()))||{};
  const notes=JSON.parse(localStorage.getItem(noteKey()))||{};
  const note=notes[day]||"";
  detailTitle.innerText=
    `Ng√†y ${day}/${currentDate.getMonth()+1}/${currentDate.getFullYear()}`;
  detailShift.innerText=data[day]?.label||"‚Äî";
  detailHours.innerText=extractHours(note);
  detailMoney.innerText=extractMoney(note).toLocaleString();
  detailNote.innerText=note||"Kh√¥ng c√≥";
  overlay.classList.add("show");
  detailSheet.classList.add("show");
}

/* ===== MONTH ===== */
function changeMonth(step){
  currentDate.setMonth(currentDate.getMonth()+step);
  selectedDay=null;
  lastClickDay=null;
  render();
}

/* ===== ICON ===== */
function buildIcons(day,notes){
  if(!notes[day])return "";
  const n=notes[day];
  const h=extractHours(n)>0;
  const m=extractMoney(n)>0;
  let html='<div class="icon-wrap">';
  if(h)html+='<span>‚è±Ô∏è</span>';
  if(m)html+='<span>üí∞</span>';
  return html+'</div>';
}

/* ===== RENDER ===== */
function render(){
  calendar.innerHTML="";
  const y=currentDate.getFullYear();
  const m=currentDate.getMonth();
  const days=new Date(y,m+1,0).getDate();
  monthLabel.innerText=(m+1)+"/"+y;

  const data=JSON.parse(localStorage.getItem(dataKey()))||{};
  const notes=JSON.parse(localStorage.getItem(noteKey()))||{};

  let work=0,off=0,sun=0,extraH=0,extraM=0;
  const today=new Date();

  for(let i=1;i<=days;i++){
    const el=document.createElement("div");
    el.className="day";
    const d=new Date(y,m,i);

    if(d.getDay()===0){el.classList.add("sun");sun++;}
    if(d.toDateString()===today.toDateString())
      el.classList.add("today");
    if(i===selectedDay)el.classList.add("selected");

    el.innerHTML=i;

    if(data[i]){
      if(data[i].label==="¬Ω"){
        el.classList.add("half");
        work+=data[i].value;
      }
      else if(data[i].value>0){
        el.classList.add("work");
        work+=data[i].value;
        if(data[i].label==="C12")
          el.classList.add("c12");
      }
      else{
        el.classList.add("off");
        off++;
      }
      el.innerHTML+=`<div class="shift-label">${data[i].label}</div>`;
    }

    if(notes[i]){
      extraH+=extractHours(notes[i]);
      extraM+=extractMoney(notes[i]);
      el.innerHTML+=buildIcons(i,notes);
    }

    el.onclick=()=>{
      if(selectedDay===i && lastClickDay===i){
        openDetail(i);
      }else{
        selectedDay=i;
        lastClickDay=i;
        render();
      }
    };

    calendar.appendChild(el);
  }

  const standardDaysValue=days-sun;
  const salaryMonth=Number(localStorage.getItem("salary"))||0;
  const salaryPerDay=
    standardDaysValue>0
      ? salaryMonth/standardDaysValue
      :0;

  const overtimeWork=extraH/8;
  const totalWorkValue=work+overtimeWork;
  const totalSalaryValue=
    (totalWorkValue*salaryPerDay)+extraM;

  totalDays.innerText=days;
  sundayCount.innerText=sun;
  standardDays.innerText=standardDaysValue;
  salaryDisplay2.innerText=Math.round(salaryPerDay).toLocaleString();

  workDays.innerText=work;
  offDays.innerText=off;
  overtimeHours.innerText=extraH;
  overtimeWorkText.innerText=
    overtimeWork % 1 === 0
      ? overtimeWork
      : overtimeWork.toFixed(2);

  extraMoney.innerText=extraM.toLocaleString();
  totalWork.innerText=totalWorkValue.toFixed(2);
  totalSalary.innerText=Math.round(totalSalaryValue).toLocaleString();
}

render();

/* ===== iOS KEYBOARD FIX ===== */
const noteTextarea=document.getElementById("noteInput");
function updateKeyboardHeight(){
  if(window.visualViewport){
    const kb=window.innerHeight-visualViewport.height;
    document.documentElement
      .style.setProperty("--kb-height",kb+"px");
  }
}
noteTextarea.addEventListener("focus",()=>{
  updateKeyboardHeight();
  noteSheet.classList.add("keyboard-up");
});
noteTextarea.addEventListener("blur",()=>{
  noteSheet.classList.remove("keyboard-up");
});
if(window.visualViewport){
  visualViewport.addEventListener(
    "resize",updateKeyboardHeight);
}

</script>

</body>
</html>
