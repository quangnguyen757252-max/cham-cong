<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Chấm Công Cá Nhân</title>

<style>
*{box-sizing:border-box}
html,body{
  height:100%;
  overflow:hidden;
  overscroll-behavior:none;
  touch-action:none;
}
body{
  position:fixed;
  inset:0;
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#000;
  background-size:cover;
  background-position:center;
}

/* ===== DỜI TOÀN BỘ BỐ CỤC LÊN ===== */
.wrapper{
  height:100%;
  padding:6px 20px 14px;   /* xích lên trên */
  display:flex;
  align-items:flex-start;
}

.card{
  width:100%;
  max-width:1000px;
  margin:auto;
  padding:16px;
  padding-bottom:calc(16px + env(safe-area-inset-bottom));
  border-radius:30px;
  background:rgba(255,255,255,.15);
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

/* TITLE + CLOCK */
.title{
  text-align:center;
  font-size:32px;
  font-weight:900;
  color:#0a84ff;
}
.clock{
  margin:6px auto 8px;
  padding:6px 12px;
  border-radius:14px;
  text-align:center;
  color:#fff;
  background:rgba(10,132,255,.25);
  font-weight:800;
}
.clock .date{font-size:12px}
.clock .time{font-size:20px}

/* AVATAR */
.avatar{
  width:100px;height:100px;
  border-radius:50%;
  background:#e5e5ea;
  margin:8px auto;
  background-size:cover;
  background-position:center;
  border:4px solid #fff;
  cursor:pointer;
}

/* INFO */
.info-box{
  background:rgba(255,255,255,.65);
  border-radius:18px;
  padding:8px;
}
.info-header{
  display:flex;
  justify-content:space-between;
  font-weight:800;
  cursor:pointer;
}
.info-content{
  max-height:0;
  overflow:hidden;
  transition:.3s;
}
.info-content.active{max-height:240px;margin-top:6px}
.info-content input{
  width:100%;
  padding:8px;
  border-radius:12px;
  border:none;
  margin:4px 0;
}

/* BUTTONS */
.action-row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin:8px 0;
}
.action-row button{
  padding:11px;
  border:none;
  border-radius:30px;
  font-weight:800;
}
.primary{background:#34c759;color:#fff}
.danger{background:#ff3b30;color:#fff}
.noteBtn{background:#007aff;color:#fff}
.gray{background:#8e8e93;color:#fff}

/* MONTH */
.month-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:900;
}
.month-bar button{
  background:#007aff;
  border:none;
  color:#fff;
  border-radius:14px;
  padding:4px 12px;
}

/* CALENDAR */
.week{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  text-align:center;
  font-weight:800;
}
.week div:last-child{color:#ff3b30}
.calendar{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:5px;
  margin-top:5px;
}
.day{
  position:relative;
  padding:6px;   /* giảm chiều cao ô */
  border-radius:12px;
  background:rgba(255,255,255,.75);
  text-align:center;
  font-weight:800;
  cursor:pointer;
}
.day.selected{outline:3px solid #007aff}
.day.today{outline:3px solid #34c759}
.day.sun{color:#ff3b30}
.shift-label{font-size:10px;font-weight:900}
.work{background:#c7f3d1}
.off{background:#ffd1d1}
.dot{
  position:absolute;
  right:4px;bottom:4px;
  width:6px;height:6px;
  border-radius:50%;
  background:#007aff;
}

/* SUMMARY */
.summary{
  margin-top:6px;
  padding:8px;
  border-radius:18px;
  background:rgba(255,255,255,.75);
  font-size:13px;
}
.summary-bottom{
  display:flex;
  justify-content:space-between;
  font-weight:900;
}

/* OVERLAY + SHEET */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  z-index:9;
}
.overlay.show{display:block}
.sheet{
  position:fixed;
  left:0;right:0;
  bottom:-100%;
  background:#fff;
  border-radius:28px 28px 0 0;
  padding:22px;
  transition:.35s;
  z-index:10;
}
.sheet.show{bottom:0}
.sheet button{
  width:100%;
  margin:8px 0;
  padding:18px;
  border-radius:24px;
  font-weight:900;
}
#noteSheet textarea{
  width:100%;
  height:120px;
  font-size:15px;
  padding:10px;
}
</style>
</head>

<body>

<div class="wrapper">
<div class="card">

<div class="title" id="appTitle">Chấm Công</div>

<div class="clock">
  <div class="date" id="dateText"></div>
  <div class="time" id="timeText"></div>
</div>

<div class="avatar" id="avatar"></div>
<input type="file" id="avatarInput" hidden accept="image/*">
<input type="file" id="bgInput" hidden accept="image/*">

<div class="info-box">
  <div class="info-header" onclick="toggleInfo()">
    <span>Thông tin cá nhân</span><span id="arrow">▼</span>
  </div>
  <div class="info-content" id="infoContent">
    <input id="nameInput" placeholder="Tên">
    <input id="jobInput" placeholder="Công việc">
    <input id="salaryInput" type="number" placeholder="Lương/ngày">
    <button class="primary" onclick="saveProfile()">Lưu</button>
  </div>
  <div>
    Tên: <b id="nameDisplay">—</b><br>
    Công việc: <b id="jobDisplay">—</b><br>
    Lương/ngày: <b id="salaryDisplay">0</b> đ
  </div>
</div>

<div class="action-row">
  <button class="primary" onclick="openShift()">Đi làm</button>
  <button class="danger" onclick="markOff()">Nghỉ</button>
  <button class="noteBtn" onclick="openNote()">Ghi chú</button>
  <button class="gray" onclick="openReset()">Reset</button>
</div>

<div class="month-bar">
  <button onclick="changeMonth(-1)">◀</button>
  <div id="monthLabel"></div>
  <button onclick="changeMonth(1)">▶</button>
</div>

<div class="week">
  <div>T2</div><div>T3</div><div>T4</div>
  <div>T5</div><div>T6</div><div>T7</div><div>CN</div>
</div>

<div class="calendar" id="calendar"></div>

<div class="summary">
  Tháng có: <span id="totalDays">0</span> ngày<br>
  Chủ nhật: <span id="sundayCount">0</span> ngày<br>
  Ngày công chuẩn: <span id="standardDays">0</span> ngày
  <hr>
  Ngày làm: <span id="workDays">0</span><br>
  Ngày nghỉ: <span id="offDays">0</span><br>
  Giờ tăng ca: <span id="overtimeHours">0</span> giờ
  <hr>
  Tiền thêm: <span id="extraMoney">0</span> đ
  <div class="summary-bottom">
    <div>Tổng công: <span id="totalWork">0</span></div>
    <div>Tổng lương: <span id="totalSalary">0</span> đ</div>
  </div>
</div>

</div>
</div>

<div class="overlay" id="overlay" onclick="closeAll()"></div>

<!-- AVATAR MENU -->
<div class="sheet" id="avatarSheet">
  <button class="primary" onclick="avatarInput.click()">Đổi avatar</button>
  <button class="noteBtn" onclick="bgInput.click()">Đổi ảnh nền</button>
  <button class="gray" onclick="closeAll()">Đóng</button>
</div>

<!-- SHIFT -->
<div class="sheet" id="shiftSheet">
  <button onclick="selectShift('C1',1)">Ca 1</button>
  <button onclick="selectShift('C2',1)">Ca 2</button>
  <button onclick="selectShift('C3',1)">Ca 3</button>
  <button onclick="selectShift('C12',1)">Ca 12</button>
  <button onclick="selectShift('HC',1)">Ca hành chánh</button>
  <button onclick="selectShift('½',0.5)">Nửa ca</button>
  <button class="gray" onclick="closeAll()">Đóng</button>
</div>

<!-- NOTE -->
<div class="sheet" id="noteSheet">
  <textarea id="noteInput" placeholder="VD: tăng ca 4h, tàu 50k"></textarea>
  <button class="primary" onclick="saveNote()">Lưu</button>
  <button class="gray" onclick="closeAll()">Đóng</button>
</div>

<!-- RESET -->
<div class="sheet" id="resetSheet">
  <h3 style="text-align:center">Xác nhận reset?</h3>
  <button class="danger" onclick="confirmReset()">Reset</button>
  <button class="gray" onclick="closeAll()">Huỷ</button>
</div>

<!-- DETAIL -->
<div class="sheet" id="detailSheet">
  <h3 id="detailTitle" style="text-align:center;margin-top:0"></h3>
  <p><b>Ca làm:</b> <span id="detailShift">—</span></p>
  <p><b>Giờ tăng ca:</b> <span id="detailHours">0</span> giờ</p>
  <p><b>Tiền thêm:</b> <span id="detailMoney">0</span> đ</p>
  <p><b>Ghi chú:</b></p>
  <div id="detailNote" style="background:#f2f2f7;padding:10px;border-radius:10px">Không có</div>
  <button class="gray" onclick="closeAll()">Đóng</button>
</div>

<script>
/* CLOCK */
const daysVN=["Chủ nhật","Thứ 2","Thứ 3","Thứ 4","Thứ 5","Thứ 6","Thứ 7"];
setInterval(()=>{
  const d=new Date();
  dateText.innerText=`${daysVN[d.getDay()]} • ${d.toLocaleDateString()}`;
  timeText.innerText=d.toLocaleTimeString();
},1000);

/* PROFILE */
function toggleInfo(){
  infoContent.classList.toggle("active");
  arrow.innerText=infoContent.classList.contains("active")?"▲":"▼";
}
function saveProfile(){
  localStorage.setItem("name",nameInput.value);
  localStorage.setItem("job",jobInput.value);
  localStorage.setItem("salary",salaryInput.value);
  updateProfile();
}
function updateProfile(){
  nameDisplay.innerText=localStorage.getItem("name")||"—";
  jobDisplay.innerText=localStorage.getItem("job")||"—";
  salaryDisplay.innerText=localStorage.getItem("salary")||0;
  appTitle.innerText=localStorage.getItem("name")||"Chấm Công";
}
updateProfile();

/* AVATAR */
avatar.onclick=()=>{
  overlay.classList.add("show");
  avatarSheet.classList.add("show");
};
avatarInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{avatar.style.backgroundImage=`url(${r.result})`;localStorage.setItem("avatar",r.result)};
  r.readAsDataURL(e.target.files[0]);
};
bgInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{document.body.style.backgroundImage=`url(${r.result})`;localStorage.setItem("bg",r.result)};
  r.readAsDataURL(e.target.files[0]);
};
if(localStorage.getItem("avatar")) avatar.style.backgroundImage=`url(${localStorage.getItem("avatar")})`;
if(localStorage.getItem("bg")) document.body.style.backgroundImage=`url(${localStorage.getItem("bg")})`;

/* DATA + LOGIC */
let currentDate=new Date(),selectedDay=new Date().getDate();
const dataKey=()=>`data-${currentDate.getFullYear()}-${currentDate.getMonth()}`;
const noteKey=()=>`note-${currentDate.getFullYear()}-${currentDate.getMonth()}`;
const extractMoney=t=>{const k=t?.match(/(\d+)\s*k/i);return k?k[1]*1000:0}
const extractHours=t=>(t?.match(/(\d+(\.\d+)?)\s*h/gi)||[]).reduce((s,v)=>s+parseFloat(v),0);

function updateMonthLabel(){monthLabel.innerText=(currentDate.getMonth()+1)+"/"+currentDate.getFullYear()}
function changeMonth(step){currentDate.setMonth(currentDate.getMonth()+step);selectedDay=1;updateMonthLabel();render()}
function openShift(){overlay.classList.add("show");shiftSheet.classList.add("show")}
function openNote(){overlay.classList.add("show");noteSheet.classList.add("show")}
function openReset(){overlay.classList.add("show");resetSheet.classList.add("show")}
function closeAll(){
  overlay.classList.remove("show");
  avatarSheet.classList.remove("show");
  shiftSheet.classList.remove("show");
  noteSheet.classList.remove("show");
  resetSheet.classList.remove("show");
  detailSheet.classList.remove("show");
}
function selectShift(l,v){
  const d=JSON.parse(localStorage.getItem(dataKey()))||{};
  d[selectedDay]={label:l,value:v};
  localStorage.setItem(dataKey(),JSON.stringify(d));
  closeAll();render();
}
function markOff(){
  const d=JSON.parse(localStorage.getItem(dataKey()))||{};
  d[selectedDay]={label:"OFF",value:0};
  localStorage.setItem(dataKey(),JSON.stringify(d));
  render();
}
function saveNote(){
  const n=JSON.parse(localStorage.getItem(noteKey()))||{};
  n[selectedDay]=noteInput.value;
  localStorage.setItem(noteKey(),JSON.stringify(n));
  closeAll();render();
}
function confirmReset(){
  localStorage.removeItem(dataKey());
  localStorage.removeItem(noteKey());
  render();closeAll();
}
function openDetail(day){
  const data=JSON.parse(localStorage.getItem(dataKey()))||{};
  const notes=JSON.parse(localStorage.getItem(noteKey()))||{};
  const note=notes[day]||"";
  detailTitle.innerText=`Ngày ${day}/${currentDate.getMonth()+1}/${currentDate.getFullYear()}`;
  detailShift.innerText=data[day]?.label||"—";
  detailHours.innerText=extractHours(note);
  detailMoney.innerText=extractMoney(note).toLocaleString();
  detailNote.innerText=note||"Không có";
  overlay.classList.add("show");
  detailSheet.classList.add("show");
}

/* RENDER */
function render(){
  calendar.innerHTML="";
  const y=currentDate.getFullYear(),m=currentDate.getMonth();
  const days=new Date(y,m+1,0).getDate();
  const data=JSON.parse(localStorage.getItem(dataKey()))||{};
  const notes=JSON.parse(localStorage.getItem(noteKey()))||{};
  let work=0,off=0,sun=0,extraH=0,extraM=0;
  const today=new Date();

  for(let i=1;i<=days;i++){
    const el=document.createElement("div");
    el.className="day";
    if(i===selectedDay) el.classList.add("selected");
    const d=new Date(y,m,i);
    if(d.getDay()===0){el.classList.add("sun");sun++}
    if(d.toDateString()===today.toDateString()) el.classList.add("today");
    el.innerHTML=i;

    if(data[i]){
      if(data[i].value>0){el.classList.add("work");work+=data[i].value}
      else{el.classList.add("off");off++}
      el.innerHTML+=`<div class="shift-label">${data[i].label}</div>`;
    }
    if(notes[i]){
      el.innerHTML+=`<div class="dot"></div>`;
      extraH+=extractHours(notes[i]);
      extraM+=extractMoney(notes[i]);
    }
    el.onclick=()=>{selectedDay=i;render();openDetail(i)};
    calendar.appendChild(el);
  }

  const overtimeWork=extraH/8;
  const totalWorkValue=work+overtimeWork;
  const salaryPerDay=Number(localStorage.getItem("salary"))||0;
  const totalSalaryValue=(totalWorkValue*salaryPerDay)+extraM;

  totalDays.innerText=days;
  sundayCount.innerText=sun;
  standardDays.innerText=days-sun;
  workDays.innerText=work;
  offDays.innerText=off;
  overtimeHours.innerText=extraH;
  extraMoney.innerText=extraM.toLocaleString();
  totalWork.innerText=totalWorkValue.toFixed(2);
  totalSalary.innerText=totalSalaryValue.toLocaleString();
}
updateMonthLabel();render();
</script>

</body>
</html>
