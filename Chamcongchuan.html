<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ch·∫•m C√¥ng C√° Nh√¢n</title>

<style>
*{box-sizing:border-box}
html,body{
  height:100%;
  overflow:hidden;
  overscroll-behavior:none;
  touch-action:none;
}
body{
  position:fixed;
  inset:0;
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#000;
  background-size:cover;
  background-position:center;
}

/* ===== LAYOUT ===== */
.wrapper{height:100%;padding:6px 20px 14px;display:flex}
.card{
  width:100%;max-width:1000px;margin:auto;padding:16px;
  padding-bottom:calc(16px + env(safe-area-inset-bottom));
  border-radius:30px;
  background:rgba(255,255,255,.15);
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

/* ===== TITLE + CLOCK ===== */
.title{text-align:center;font-size:32px;font-weight:900;color:#0a84ff}
.clock{
  margin:6px auto 8px;padding:6px 12px;border-radius:14px;
  text-align:center;color:#fff;background:rgba(10,132,255,.25);font-weight:800
}
.clock .date{font-size:12px}
.clock .time{font-size:20px}

/* ===== AVATAR ===== */
.avatar{
  width:100px;height:100px;border-radius:50%;
  background:#e5e5ea;margin:8px auto;
  background-size:cover;background-position:center;
  border:4px solid #fff
}

/* ===== INFO ===== */
.info-box{background:rgba(255,255,255,.65);border-radius:18px;padding:8px}
.info-header{display:flex;justify-content:space-between;font-weight:800;cursor:pointer}
.info-content{max-height:0;overflow:hidden;transition:.3s}
.info-content.active{max-height:260px;margin-top:6px}
.info-content input{
  width:100%;padding:8px;border-radius:12px;border:none;margin:4px 0
}

/* ===== BUTTON ===== */
.action-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:8px 0}
.action-row button{padding:11px;border:none;border-radius:30px;font-weight:800}
.primary{background:#34c759;color:#fff}
.danger{background:#ff3b30;color:#fff}
.noteBtn{background:#007aff;color:#fff}
.gray{background:#8e8e93;color:#fff}

/* ===== MONTH + CALENDAR ===== */
.month-bar{display:flex;justify-content:space-between;align-items:center;font-weight:900}
.month-bar button{background:#007aff;border:none;color:#fff;border-radius:14px;padding:4px 12px}
.week{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-weight:800}
.week div:last-child{color:#ff3b30}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-top:5px}
.day{
  position:relative;padding:6px;border-radius:12px;
  background:rgba(255,255,255,.75);text-align:center;font-weight:800
}
.day.selected{outline:3px solid #007aff}
.day.today{outline:3px solid #34c759}
.day.sun{color:#ff3b30}
.shift-label{font-size:10px;font-weight:900}
.work{background:#c7f3d1}
.off{background:#ffd1d1}

/* ===== ICON ===== */
.icon-wrap{position:absolute;right:4px;bottom:4px;display:flex;gap:2px;font-size:11px}
.icon-dot{width:6px;height:6px;border-radius:50%;background:#007aff}

/* ===== SUMMARY ===== */
.summary{
  margin-top:6px;padding:8px;border-radius:18px;
  background:rgba(255,255,255,.75);font-size:13px
}
.summary-bottom{display:flex;justify-content:space-between;font-weight:900}

/* ===== SHEET ===== */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:9}
.overlay.show{display:block}
.sheet{
  position:fixed;left:0;right:0;bottom:-100%;
  background:#fff;border-radius:28px 28px 0 0;
  padding:22px;transition:.35s;z-index:10
}
.sheet.show{bottom:0}
.sheet button{
  width:100%;margin:8px 0;padding:18px;border-radius:24px;font-weight:900
}

/* ===== NOTE FIX iOS ===== */
.sheet.keyboard-up{transform:translateY(calc(-1 * var(--kb-height,260px)))}
#noteInput{
  width:100%;height:120px;font-size:15px;
  padding:10px;border-radius:14px;resize:none
}
</style>
</head>

<body>

<div class="wrapper">
<div class="card">

<div class="title" id="appTitle">Ch·∫•m C√¥ng</div>

<div class="clock">
  <div class="date" id="dateText"></div>
  <div class="time" id="timeText"></div>
</div>

<div class="avatar" id="avatar"></div>
<input type="file" id="avatarInput" hidden accept="image/*">
<input type="file" id="bgInput" hidden accept="image/*">

<div class="info-box">
  <div class="info-header" onclick="toggleInfo()">
    <span>Th√¥ng tin c√° nh√¢n</span><span id="arrow">‚ñº</span>
  </div>
  <div class="info-content" id="infoContent">
    <input id="nameInput" placeholder="T√™n">
    <input id="jobInput" placeholder="C√¥ng vi·ªác">
    <input id="salaryInput" type="number" placeholder="L∆∞∆°ng/ng√†y">
    <button class="primary" onclick="saveProfile()">L∆∞u</button>
  </div>
  <div>
    T√™n: <b id="nameDisplay">‚Äî</b><br>
    C√¥ng vi·ªác: <b id="jobDisplay">‚Äî</b><br>
    L∆∞∆°ng/ng√†y: <b id="salaryDisplay">0</b> ƒë
  </div>
</div>

<div class="action-row">
  <button class="primary" onclick="openShift()">ƒêi l√†m</button>
  <button class="danger" onclick="markOff()">Ngh·ªâ</button>
  <button class="noteBtn" onclick="openNote()">Ghi ch√∫</button>
  <button class="gray" onclick="openReset()">Reset</button>
</div>

<div class="month-bar">
  <button onclick="changeMonth(-1)">‚óÄ</button>
  <div id="monthLabel"></div>
  <button onclick="changeMonth(1)">‚ñ∂</button>
</div>

<div class="week">
  <div>T2</div><div>T3</div><div>T4</div>
  <div>T5</div><div>T6</div><div>T7</div><div>CN</div>
</div>

<div class="calendar" id="calendar"></div>

<div class="summary">
  Th√°ng c√≥: <span id="totalDays">0</span> ng√†y<br>
  Ch·ªß nh·∫≠t: <span id="sundayCount">0</span> ng√†y<br>
  Ng√†y c√¥ng chu·∫©n: <span id="standardDays">0</span> ng√†y
  <hr>
  Ng√†y l√†m: <span id="workDays">0</span><br>
  Ng√†y ngh·ªâ: <span id="offDays">0</span><br>
  Gi·ªù tƒÉng ca: <span id="overtimeHours">0</span> gi·ªù
  <hr>
  Ti·ªÅn th√™m: <span id="extraMoney">0</span> ƒë
  <div class="summary-bottom">
    <div>T·ªïng c√¥ng: <span id="totalWork">0</span></div>
    <div>T·ªïng l∆∞∆°ng: <span id="totalSalary">0</span> ƒë</div>
  </div>
</div>

</div>
</div>

<div class="overlay" id="overlay" onclick="closeAll()"></div>

<div class="sheet" id="avatarSheet">
  <button class="primary" onclick="avatarInput.click()">ƒê·ªïi avatar</button>
  <button class="noteBtn" onclick="bgInput.click()">ƒê·ªïi ·∫£nh n·ªÅn</button>
  <button class="gray" onclick="closeAll()">ƒê√≥ng</button>
</div>

<div class="sheet" id="shiftSheet">
  <button onclick="selectShift('C1',1)">Ca 1</button>
  <button onclick="selectShift('C2',1)">Ca 2</button>
  <button onclick="selectShift('C3',1)">Ca 3</button>
  <button onclick="selectShift('C12',1.5)">Ca 12</button>
  <button onclick="selectShift('HC',1)">H√†nh ch√°nh</button>
  <button onclick="selectShift('¬Ω',0.5)">N·ª≠a ca</button>
  <button class="gray" onclick="closeAll()">ƒê√≥ng</button>
</div>

<div class="sheet" id="noteSheet">
  <b>Ghi ch√∫</b>
  <textarea id="noteInput" placeholder="VD: tƒÉng ca 4h, t√†u 50k"></textarea>
  <button class="primary" onclick="saveNote()">L∆∞u</button>
  <button class="gray" onclick="closeAll()">ƒê√≥ng</button>
</div>

<div class="sheet" id="resetSheet">
  <h3 style="text-align:center">X√°c nh·∫≠n reset?</h3>
  <button class="danger" onclick="confirmReset()">Reset</button>
  <button class="gray" onclick="closeAll()">Hu·ª∑</button>
</div>

<div class="sheet" id="detailSheet">
  <h3 id="detailTitle" style="text-align:center;margin-top:0"></h3>
  <p><b>Ca l√†m:</b> <span id="detailShift">‚Äî</span></p>
  <p><b>Gi·ªù tƒÉng ca:</b> <span id="detailHours">0</span> gi·ªù</p>
  <p><b>Ti·ªÅn th√™m:</b> <span id="detailMoney">0</span> ƒë</p>
  <p><b>Ghi ch√∫:</b></p>
  <div id="detailNote" style="background:#f2f2f7;padding:10px;border-radius:10px">Kh√¥ng c√≥</div>
  <button class="gray" onclick="closeAll()">ƒê√≥ng</button>
</div>

<script>
/* ================= CLOCK ================= */
const daysVN=["Ch·ªß nh·∫≠t","Th·ª© 2","Th·ª© 3","Th·ª© 4","Th·ª© 5","Th·ª© 6","Th·ª© 7"];
setInterval(()=>{
  const d=new Date();
  dateText.innerText=`${daysVN[d.getDay()]} ‚Ä¢ ${d.toLocaleDateString()}`;
  timeText.innerText=d.toLocaleTimeString();
},1000);

/* ================= PROFILE ================= */
function toggleInfo(){
  infoContent.classList.toggle("active");
  arrow.innerText=infoContent.classList.contains("active")?"‚ñ≤":"‚ñº";
}
function saveProfile(){
  localStorage.setItem("name",nameInput.value.trim());
  localStorage.setItem("job",jobInput.value.trim());
  localStorage.setItem("salary",salaryInput.value||0);
  updateProfile();
}
function updateProfile(){
  nameDisplay.innerText=localStorage.getItem("name")||"‚Äî";
  jobDisplay.innerText=localStorage.getItem("job")||"‚Äî";
  salaryDisplay.innerText=Number(localStorage.getItem("salary")||0).toLocaleString();
  appTitle.innerText=localStorage.getItem("name")||"Ch·∫•m C√¥ng";
}
updateProfile();

/* ================= AVATAR + BACKGROUND ================= */
avatar.onclick=()=>{
  overlay.classList.add("show");
  avatarSheet.classList.add("show");
};
avatarInput.onchange=e=>{
  if(!e.target.files[0])return;
  const r=new FileReader();
  r.onload=()=>{
    avatar.style.backgroundImage=`url(${r.result})`;
    localStorage.setItem("avatar",r.result);
  };
  r.readAsDataURL(e.target.files[0]);
};
bgInput.onchange=e=>{
  if(!e.target.files[0])return;
  const r=new FileReader();
  r.onload=()=>{
    document.body.style.backgroundImage=`url(${r.result})`;
    localStorage.setItem("bg",r.result);
  };
  r.readAsDataURL(e.target.files[0]);
};
if(localStorage.getItem("avatar"))
  avatar.style.backgroundImage=`url(${localStorage.getItem("avatar")})`;
if(localStorage.getItem("bg"))
  document.body.style.backgroundImage=`url(${localStorage.getItem("bg")})`;

/* ================= DATA ================= */
let currentDate=new Date();
let selectedDay=null;
let lastClickDay=null;

const dataKey=()=>`data-${currentDate.getFullYear()}-${currentDate.getMonth()}`;
const noteKey=()=>`note-${currentDate.getFullYear()}-${currentDate.getMonth()}`;

function extractMoney(t){
  const m=t?.match(/(\d+)\s*k/i);
  return m?Number(m[1])*1000:0;
}
function extractHours(t){
  const h=t?.match(/(\d+(?:\.\d+)?)\s*h/gi)||[];
  return h.reduce((s,v)=>s+parseFloat(v),0);
}

/* ================= OPEN / CLOSE ================= */
function openShift(){
  if(selectedDay===null){alert("Ch·ªçn ng√†y tr∆∞·ªõc");return;}
  overlay.classList.add("show");
  shiftSheet.classList.add("show");
}
function openNote(){
  if(selectedDay===null){alert("Ch·ªçn ng√†y tr∆∞·ªõc");return;}
  const notes=JSON.parse(localStorage.getItem(noteKey()))||{};
  noteInput.value=notes[selectedDay]||"";
  overlay.classList.add("show");
  noteSheet.classList.add("show");
}
function openReset(){
  overlay.classList.add("show");
  resetSheet.classList.add("show");
}
function closeAll(){
  overlay.classList.remove("show");
  avatarSheet.classList.remove("show");
  shiftSheet.classList.remove("show");
  noteSheet.classList.remove("show");
  resetSheet.classList.remove("show");
  detailSheet.classList.remove("show");
}

/* ================= ACTION ================= */
/* Ca 12 = 1.5 c√¥ng ‚Äì KH√îNG auto OT */
function selectShift(label,value){
  const d=JSON.parse(localStorage.getItem(dataKey()))||{};
  d[selectedDay]={label,value};
  localStorage.setItem(dataKey(),JSON.stringify(d));
  closeAll();
  render();
}
function markOff(){
  if(selectedDay===null){alert("Ch·ªçn ng√†y tr∆∞·ªõc");return;}
  const d=JSON.parse(localStorage.getItem(dataKey()))||{};
  d[selectedDay]={label:"OFF",value:0};
  localStorage.setItem(dataKey(),JSON.stringify(d));
  closeAll();
  render();
}
function saveNote(){
  const n=JSON.parse(localStorage.getItem(noteKey()))||{};
  n[selectedDay]=noteInput.value||"";
  localStorage.setItem(noteKey(),JSON.stringify(n));
  noteInput.value="";
  closeAll();
  render();
}
function confirmReset(){
  localStorage.removeItem(dataKey());
  localStorage.removeItem(noteKey());
  selectedDay=null;
  lastClickDay=null;
  render();
  closeAll();
}

/* ================= DETAIL ================= */
function openDetail(day){
  const data=JSON.parse(localStorage.getItem(dataKey()))||{};
  const notes=JSON.parse(localStorage.getItem(noteKey()))||{};
  const note=notes[day]||"";
  detailTitle.innerText=`Ng√†y ${day}/${currentDate.getMonth()+1}/${currentDate.getFullYear()}`;
  detailShift.innerText=data[day]?.label||"‚Äî";
  detailHours.innerText=extractHours(note);
  detailMoney.innerText=extractMoney(note).toLocaleString();
  detailNote.innerText=note||"Kh√¥ng c√≥";
  overlay.classList.add("show");
  detailSheet.classList.add("show");
}

/* ================= MONTH ================= */
function updateMonthLabel(){
  monthLabel.innerText=(currentDate.getMonth()+1)+"/"+currentDate.getFullYear();
}
function changeMonth(step){
  currentDate.setMonth(currentDate.getMonth()+step);
  selectedDay=null;
  lastClickDay=null;
  updateMonthLabel();
  render();
}

/* ================= ICON ================= */
function buildIcons(day,notes){
  if(!notes[day])return "";
  const n=notes[day];
  const h=extractHours(n)>0;
  const m=extractMoney(n)>0;
  let html='<div class="icon-wrap"><span class="icon-dot"></span>';
  if(h)html+='<span>‚è±Ô∏è</span>';
  if(m)html+='<span>üí∞</span>';
  return html+'</div>';
}

/* ================= RENDER ================= */
function render(){
  calendar.innerHTML="";
  const y=currentDate.getFullYear();
  const m=currentDate.getMonth();
  const days=new Date(y,m+1,0).getDate();

  const data=JSON.parse(localStorage.getItem(dataKey()))||{};
  const notes=JSON.parse(localStorage.getItem(noteKey()))||{};

  let work=0,off=0,sun=0,extraH=0,extraM=0;
  const today=new Date();

  for(let i=1;i<=days;i++){
    const el=document.createElement("div");
    el.className="day";
    const d=new Date(y,m,i);

    if(d.getDay()===0){el.classList.add("sun");sun++;}
    if(d.toDateString()===today.toDateString())el.classList.add("today");
    if(i===selectedDay)el.classList.add("selected");

    el.innerHTML=i;

    if(data[i]){
      if(data[i].value>0){
        el.classList.add("work");
        work+=data[i].value;
      }else{
        el.classList.add("off");
        off++;
      }
      el.innerHTML+=`<div class="shift-label">${data[i].label}</div>`;
    }

    if(notes[i]){
      extraH+=extractHours(notes[i]);
      extraM+=extractMoney(notes[i]);
      el.innerHTML+=buildIcons(i,notes);
    }

    el.onclick=()=>{
      if(selectedDay===i && lastClickDay===i){
        openDetail(i);
      }else{
        selectedDay=i;
        lastClickDay=i;
        render();
      }
    };
    calendar.appendChild(el);
  }

  const overtimeWork=extraH/8;
  const totalWorkValue=work+overtimeWork;
  const salaryPerDay=Number(localStorage.getItem("salary"))||0;
  const totalSalaryValue=(totalWorkValue*salaryPerDay)+extraM;

  totalDays.innerText=days;
  sundayCount.innerText=sun;
  standardDays.innerText=days-sun;
  workDays.innerText=work;
  offDays.innerText=off;
  overtimeHours.innerText=extraH;
  extraMoney.innerText=extraM.toLocaleString();
  totalWork.innerText=totalWorkValue.toFixed(2);
  totalSalary.innerText=totalSalaryValue.toLocaleString();
}

/* ================= NOTE iOS FIX ================= */
const noteTextarea=document.getElementById("noteInput");
function updateKeyboardHeight(){
  if(window.visualViewport){
    const kb=window.innerHeight-visualViewport.height;
    document.documentElement.style.setProperty("--kb-height",kb+"px");
  }
}
noteTextarea.addEventListener("focus",()=>{
  updateKeyboardHeight();
  noteSheet.classList.add("keyboard-up");
});
noteTextarea.addEventListener("blur",()=>{
  noteSheet.classList.remove("keyboard-up");
});
if(window.visualViewport){
  visualViewport.addEventListener("resize",updateKeyboardHeight);
}
overlay.addEventListener("click",()=>{
  if(document.activeElement===noteTextarea)noteTextarea.blur();
});

/* ================= INIT ================= */
updateMonthLabel();
render();
</script>

</body>
</html>
